DPSK3 Closed Loop Voltage Mode Control 
======================================

This code example establishes a closed loop control system using voltage mode control
of the boost converter of the Digital Power Starter Kit 3 (Part-No. DM330017-3).

The control system consists of two major blocks:

    - Boost Converter State Machine (startup and runtime control, fault detection and auto-recovery)
    - Cycle-by-Cycle Voltage Control Loop

Optional:

    - Alternative Proportional Controller Routine supporting Plant Measurements


Please read the section 'Software Quick-Start Guide' below for more details.


Test-Point Usage:
-----------------

Hardware:

    TP1  = Input Voltage
    TP12 = Boost Converter Output Voltage

    TP11 = Boost Converter Switch Node
    TP31 = Boost Converter PWM High Side
    TP30 = Boost Converter PWM Low Side

    TP33 = Feedback Loop Injection Point A (low impedance)
    TP34 = Feedback Loop Injection Point B (high impedance)

    TP37 = Current Sense Transformer Feedback
    TP39 = Current Sense Amplifier Feedback (optional component, may be not populated by default)
    
    TP66 = Power Good output

    DPSK3 Test Point-Overview (Pat-No: DM330017-3, Rev3.0):

        -------------------------------------------
       |  |          | |_| |  |               TP12 |
       |  |          |     |__|                    |
       |   ----------        TP1                   |
       |           TP33                            |
       |           TP34   TP11         <BOOST_LOAD> |
       |           TP30                            |
       |           TP31               <BOOST_LOAD> |
       |   TP48/49                                 |
       |   TP50-53                                 |
       |          <USER>                           |
        -------------------------------------------

Software Debugging:

    TP50 = Power Control State Machine Execution debugging Pin    
    TP51 = Debugging LED (RED)
    TP52 = Voltage Loop Interrupt Execution Debugging Pin 
    TP53 = Low-Priority Task Execution Debugging Pin
    TP66 = Power Good output (controlled by power control state machine)
    TP67 = free debug pin
    TP68 = free debug pin

User Input:

    USER      = Switches between Voltage and Temperature output on LCD
    BOOST_LOAD = Switches between 0%, 25%, 50% and 100% load @ nominal VOUT of 3.3V


Tool-Chain:
-----------

    MPLAB X IDE v5.40:  http://www.microchip.com/mplabx
    MPLAB X XC16 v1.50: https://www.microchip.com/mplab/compilers
    MPLAB DPSK3 v3.0:   http://www.microchip.com/DM330017-3
    DCLD v0.9.10.660:   https://areiter128.github.io/DCLD


_________________________________________________

FIRMWARE QUICK-START GUIDE
==========================

1) Boost Converter State Machine

The state machine goes through the following steps in chronological order:

a) Initialization

In this step the control loop parameters are reset to their defaults, PWM outputs are turned off
but the PWM is still running, continuously triggering the ADC to keep sampling input and output 
voltage as well as board temperature.

b) Reset
This is the 'fall-back' state from which the boost converter will be restarted once it has been
started successfully and has been shut down due to a fault condition (e.g. input under/over 
voltage or over temperature condition)

c) Standby
After RESET, the state machine waits for all fault flags to be cleared and the enable and GO
bits to be set.

d) Power-On Delay (POD)
Once the boost converter has been cleared the state machine will execute the startup procedure
starting with the Power On Delay. This is just a simple delay during which the converter will  
remain inactive but the fault handler will observe the values generated by the ADC for occurring 
fault conditions.

e) Launch Voltage Ramp
After the Power-On delay has expired, input and output voltage will be measured. In case the 
converter output is pre-biased (voltage = non-zero), the power controller will be 'pre-charged'
with an artificial control history and PWM output to softly ramp up the output voltage from its
most recent level. 

f) Voltage Ramp-Up
Now the digital feedback loop and PWM are enabled and the closed loop system reference value
is incremented with every execution of the state machine (100usec interval). The control loop
has been adjusted to operate with a cross-over frequency of >10 kHz matching the maximum 
perturbance frequency allowed to keep the control system stable.  

g) Power Good Delay
After the reference voltage has been increased to the pre-defined nominal level, the state 
machine switches over into the Power Good Delay period. This is another, simple delay where
the control loop is in steady state waiting for the delay period to expire.

h) Online
After the Power Good Delay has expired, the converter drops into nominal operation. In this
condition it continuously observes the reference value for changes. Should any other part 
of the firmware change the controller reference, the state machine will softly tune into the
new level instead of hard-switching the reference. 

i) Suspend
If the power controller is shut down and reset by external commands (e.g. fault handler 
detecting a fault condition or through user-interaction), the state machine is switching
into the SUSPEND state, which disables the PWM outputs and control loop execution, clears 
the control histories and resets the state machine back to RESET


2) Cycle-by-Cycle Voltage Control Loop

This firmware uses a digital type III controller to close the feedback loop in voltage mode 
control. This digital loop reads the most recent ADC sample of the output voltage and processes
its value through a digital type III (3P3Z) compensation filter. The numeric output is checked 
and, when necessary, clamped to user-defined minimum/maximum thresholds before being written
to the PWM duty cycle register.

This control loop can be turned on/off by using the ENABLED bit in the STATUS word or the 
cNPNZ_t controller data structure.


3) Digital Controller Design

The control loop source code is configured and generated by using the 
Digital Control Loop Designer (DCLD). 

This additional design software is available for download by following this link:

    https://areiter128.github.io/DCLD

Once installed, the controller configuration can be modified. The most recent configuration 
can be opened by right-clicking on the file 'DPSK3_VMC.dcld' located in the Important Files
folder of the Project Manager. When right-clicked, select 'Open In System' to open the  
configuration in DCLD. The user guide of DCLD is included in the software and can be opened
from the help menu.


4) DPSK3 LCD Output and User Control

In addition to the main power supply control task, this firmware also displays runtime data
on the on-board LC display. At startup it shows the name of the firmware and then switches
over into the input/output voltage view, showing the most recent input voltage in the first 
row and the most recent output voltage on the second.

a) Startup Screen

This screen appears directly after power has been applied or a USB cable is connected to the 
board:
             ------------------
            | ==== DPSK-3 ==== |
            |  CE200 BOOST VMC  |
             ------------------

b) Runtime Screen I

This screen appears after the firmware initialization is complete and the startup delay of
approximately 1 second has expired. Data output is refreshed every 300 ms.
             ------------------
            | VIN     = 9.00 V |
            | VOUT    = 3.30 V |
             ------------------

Fault condition output Under Voltage Lock Out (UVLO):
             ------------------
            | VIN     = 4.00 V |  <= Input voltage below minimum of 6V
            | VOUT(UV)= 0.00 V |  <= converter is in Under Voltage Lock Out (UV)
             ------------------

Fault condition output Over Voltage Lock Out (OVLO):
             ------------------
            | VIN     =17.00 V |  <= Input voltage above maximum of 13.8V
            | VOUT(OV)= 0.00 V |  <= converter is in Over Voltage Lock Out (UV)
             ------------------


c) Runtime Screen II

When the user presses the USER button for more than one second, the screen changes
to the temperature view. The temperature sensor is located between the load resistor
banks of boost and boost converter.
             ------------------
            | VIN     = 9.00 V |
            | TEMP    = 25.0 C |
             ------------------

d) Runtime Screen III

When the user presses the USER button for more than one second again, the screen changes
to the output current view. This displays the most recent average output current of the
converter.
             ------------------
            | VIN     = 9.00 V |
            | TEMP    = 0.415A |
             ------------------

Press the USER button for more than one second to return to the Voltage Output screen (b)


5) Power Plant Measurement Support

This code examples includes an alternative, proportional control loop which is commonly
used during measurements of the frequency response of the power plant. When the following
define is set to TRUE, the common main control loop is replaced by the proportional controller.

    app_power_control.c, line 33:   #define PLANT_MEASUREMENT   false


PLEASE NOTE:
============
PROPORTIONAL CONTROLLERS ARE BY DEFAULT UNSTABLE AND NOT SUITED TO REGULATE THE OUTPUT
OF  POWER SUPPLY UNDER NORMAL OPERATING CONDITIONS. PLEASE READ THE SECTIONS IN THE 
DCLD USER GUIDE FOR MORE INFORMATION ABOUT HOW TO CONDUCT A POWER PLANT MEASUREMENT.

_________________________________________________
(c) 2021, Microchip Technology Inc.

